readonly CONFIG_DIR=/opt/snowplow/config

sudo mkdir -p $${CONFIG_DIR}
sudo cat << EOF > $${CONFIG_DIR}/transformer_kinesis.json
${config}
EOF

sudo cat << EOF > $${CONFIG_DIR}/iglu_resolver.json
${iglu_resolver}
EOF

# Launch the loader
sudo docker run \
  -d \
  --name transformer_kinesis \
  --restart always \
  --network host \
  --memory=${container_memory} \
%{ if cloudwatch_logs_enabled ~}
  --log-driver awslogs \
  --log-opt awslogs-group=${cloudwatch_log_group_name} \
  --log-opt awslogs-stream=$(get_instance_id) \
%{ else ~}
  --log-opt max-size=10m \
  --log-opt max-file=5 \
%{ endif ~}
  -v $${CONFIG_DIR}:/snowplow/config \
  -e 'JAVA_OPTS=${java_opts}' \
  -e "TELEMETRY_INSTANCE_ID=$(get_instance_id)" \
  snowplow/transformer-kinesis:${version} \
  --config $(base64 -w 0 $CONFIG_DIR/transformer_kinesis.json) \
  --iglu-config $(base64 -w 0 $CONFIG_DIR/iglu_resolver.json)

${telemetry_script}
